<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css">
  <title>–ë–û–ñ–ï–ú–ò–†_–ù–ú–¢</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, serverTimestamp, onDisconnect } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAuXCSl7BEcTz_fWF0Blb-h6VYyxTflmyM",
      authDomain: "bogemir-nmt.firebaseapp.com",
      projectId: "bogemir-nmt",
      storageBucket: "bogemir-nmt.firebasestorage.app",
      messagingSenderId: "623930043833",
      appId: "1:623930043833:web:8b4a89597327eee4ac1a68",
      measurementId: "G-T0PVNYX3MT"
    };

    // Initialize Firebase app and DB with explicit database URL
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app, "https://bogemir-nmt-default-rtdb.europe-west1.firebasedatabase.app");

    // Unique ID for this visitor/session
    const userId = Math.random().toString(36).slice(2, 10);
    const userRef = ref(db, 'onlineUsers/' + userId);

    function setUserOnline() {
      set(userRef, { lastOnline: serverTimestamp() })
        .catch(err => console.error("Failed to set user online:", err));
    }

    // Remove this user from onlineUsers on disconnect
    onDisconnect(userRef).remove();

    // Initial presence set
    setUserOnline();

    // Update heartbeat every 10 seconds
    setInterval(setUserOnline, 10000);

    // Listen for all online users
    const onlineUsersRef = ref(db, 'onlineUsers');

    let lastCount = 0;

onValue(onlineUsersRef, snapshot => {
  const users = snapshot.val() || {};
  const now = Date.now();
  let count = 0;

  for (const id in users) {
    if (users[id].lastOnline && (now - users[id].lastOnline) < 15000) {
      count++;
    }
  }

  const onlineCounter = document.getElementById('onlineCount');
  onlineCounter.textContent = count;

  const counterWrapper = document.getElementById('online-users-counter');

  if (count > lastCount) {
    // New user joined - bounce animation
    counterWrapper.classList.remove('animated-shake');
    counterWrapper.classList.add('animated-bounce');

    // Remove the animation class after animation ends
    setTimeout(() => {
      counterWrapper.classList.remove('animated-bounce');
    }, 600);
  } else if (count < lastCount) {
    // User left - shake animation
    counterWrapper.classList.remove('animated-bounce');
    counterWrapper.classList.add('animated-shake');

    setTimeout(() => {
      counterWrapper.classList.remove('animated-shake');
    }, 600);
  }

  lastCount = count;
});


      for (const id in users) {
        if (users[id].lastOnline && (now - users[id].lastOnline) < 15000) {
          count++;
        }
      }

      document.getElementById('onlineCount').textContent = count;
  </script>
</head>
<body class="light">

  <!-- Main content (Chat App) -->
  <div id="app-wrapper">
    <div id="brand-header">–ë–û–ñ–ï–ú–ò–†_–ù–ú–¢</div>
    <div id="container">
      <div id="chat"></div>
      <div id="input-area">
        <input id="question" type="text" placeholder="–í–∞—à–µ –ø–∏—Ç–∞–Ω–Ω—è" />
        <button id="send">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
      </div>
    </div>
  </div>
</div>

<!-- Splash Screen -->
<div id="splash">
  <div id="splash-title"></div>
  <div id="splash-subtext">–¶–µ–π –±–æ—Ç –¥–æ–ø–æ–º–æ–∂–µ –≤–∞–º –ø—ñ–¥–≥–æ—Ç—É–≤–∞—Ç–∏—Å—å –¥–æ –ù–ú–¢</div>
  <button id="start-button">–†–æ–∑–ø–æ—á–∞—Ç–∏</button>
</div>


<!-- Theme Toggle -->
<div class="theme-switch-wrapper">
  <label class="theme-switch">
    <input type="checkbox" id="theme-toggle-checkbox" />
    <span class="slider">
      <span class="icon">‚òÄÔ∏è</span>
    </span>
  </label>
</div>

<!-- Settings Button & Modal -->
<div class="settings-wrapper" style="display: flex; align-items: center; gap: 10px;">
  <div id="online-users-counter" aria-live="polite" aria-atomic="true" role="status" style="font-weight: bold;">
    üë•<span id="onlineCount">0</span>
  </div>
  <button id="settings-button" aria-label="Open settings">‚öôÔ∏è</button>
</div>

<div id="settings-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="settings-title">
  <h2 id="settings-title">–ú–ï–ù–Æ</h2>
  <button id="new-chat-btn">+ –ù–æ–≤–∞ —Ä–æ–∑–º–æ–≤–∞</button>
  <ul id="chat-history-list"></ul>
  <bl/>
  <label for="typing-sound-toggle">
    <input type="checkbox" id="typing-sound-toggle" />
    –í–∏–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫ –¥—Ä—É–∫—É
  </label>
  <br/>
  <button id="close-settings">–ó–∞–∫—Ä–∏—Ç–∏</button>
</div>

<!-- Scripts -->
<script src="set_menu.js"></script>
<script src="settings.js"></script>
<script src="header.js"></script>
<script src="theme_toggle.js"></script>
<script src="script.js"></script>
<script src="splash.js"></script>
</body>
</html>
